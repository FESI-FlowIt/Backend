<?xml version="1.0" encoding="UTF-8"?>
<Configuration status="WARN" monitorInterval="30">

    <!-- 전역 변수 정의 -->
    <Properties>
        <Property name="LOG_PATH">./logs</Property>
        <Property name="CHARSET">UTF-8</Property>
        <Property name="PATTERN_CONSOLE">%style{%d{yyyy-MM-dd HH:mm:ss.SSS}} %highlight{%-5level} [%style{%t}{bright,blue}] %style{%C{1.}}{bright,yellow} [%style{%method}{cyan}:%style{%L}{magenta}] - %msg%n%throwable</Property>
        <Property name="PATTERN_FILE">%d{yyyy-MM-dd HH:mm:ss.SSS} [%-5level] [%t] %c{1.} [%method:%L] - %msg%n%throwable</Property>
        <Property name="PATTERN_JSON_FIELDS">
            "timestamp": "%d{yyyy-MM-dd'T'HH:mm:ss.SSS'Z'}",
            "level": "%level",
            "thread": "%t",
            "logger": "%c{1.}",
            "method": "%method",
            "line": "%L",
            "message": "%enc{%msg}{JSON}",
            "exception": "%enc{%ex}{JSON}",
            "mdc": "%X"
        </Property>
        <!-- 애플리케이션별 로그 파일명 -->
        <Property name="FLOWIT_DEBUG_LOG_FILE">${LOG_PATH}/flowit.log</Property>
    </Properties>

    <Appenders>
        <!-- 콘솔 출력 -->
        <Console name="STDOUT" target="SYSTEM_OUT">
            <PatternLayout pattern="${PATTERN_CONSOLE}" charset="${CHARSET}"/>
            <ThresholdFilter level="DEBUG" onMatch="ACCEPT" onMismatch="DENY"/>
        </Console>

        <!-- 디버그 로그 파일 (DEBUG 레벨 이상) -->
        <RollingFile name="DEBUG_FILE"
                     fileName="${FLOWIT_DEBUG_LOG_FILE}"
                     filePattern="${LOG_PATH}/archive/debug.%d{yyyy-MM-dd}.%i.log">
            <PatternLayout pattern="${PATTERN_FILE}" charset="${CHARSET}"/>
            <ThresholdFilter level="DEBUG" onMatch="ACCEPT" onMismatch="DENY"/>
            <Policies>
                <TimeBasedTriggeringPolicy interval="1" modulate="true"/>
                <SizeBasedTriggeringPolicy size="100MB"/>
            </Policies>
            <DefaultRolloverStrategy max="30" fileIndex="max"/>
        </RollingFile>

        <!-- Async Appender -->
        <Async name="ASYNC_DEBUG" bufferSize="8192" includeLocation="true">
            <AppenderRef ref="DEBUG_FILE"/>
        </Async>
    </Appenders>

    <Loggers>
        <Logger name="com.fesi.flowit" level="DEBUG" additivity="false">
            <AppenderRef ref="STDOUT"/>
            <AppenderRef ref="ASYNC_DEBUG"/>
        </Logger>

        <!-- 데이터베이스 관련 로그 -->
        <Logger name="org.springframework.jdbc" level="DEBUG" additivity="false">
            <AppenderRef ref="STDOUT"/>
            <AppenderRef ref="ASYNC_DEBUG"/>
        </Logger>

        <Logger name="org.hibernate.SQL" level="DEBUG" additivity="false">
            <AppenderRef ref="STDOUT"/>
            <AppenderRef ref="ASYNC_DEBUG"/>
        </Logger>

        <Logger name="org.hibernate.type.descriptor.sql.BasicBinder" level="TRACE" additivity="false">
            <AppenderRef ref="STDOUT"/>
            <AppenderRef ref="ASYNC_DEBUG"/>
        </Logger>

        <!-- JPA/Hibernate 로그 -->
        <Logger name="org.hibernate" level="DEBUG" additivity="false">
            <AppenderRef ref="STDOUT" level="DEBUG"/>
            <AppenderRef ref="ASYNC_DEBUG" level="DEBUG"/>
        </Logger>

        <!-- HikariCP 커넥션 풀 로그 -->
        <Logger name="com.zaxxer.hikari" level="INFO" additivity="false">
            <AppenderRef ref="STDOUT"/>
            <AppenderRef ref="ASYNC_DEBUG"/>
        </Logger>

        <!-- PostgreSQL 드라이버 로그 -->
        <Logger name="org.postgresql" level="INFO" additivity="false">
            <AppenderRef ref="STDOUT"/>
            <AppenderRef ref="ASYNC_DEBUG"/>
        </Logger>

        <!-- 서드파티 라이브러리 로그 레벨 조정 -->
        <Logger name="org.apache.http" level="DEBUG" additivity="false">
            <AppenderRef ref="STDOUT"/>
            <AppenderRef ref="ASYNC_DEBUG"/>
        </Logger>

        <Logger name="org.apache.catalina" level="INFO" additivity="false">
            <AppenderRef ref="STDOUT"/>
            <AppenderRef ref="ASYNC_DEBUG"/>
        </Logger>

        <!-- Root Logger -->
        <Root level="INFO">
            <AppenderRef ref="STDOUT"/>
            <AppenderRef ref="ASYNC_DEBUG" level="DEBUG"/>
        </Root>
    </Loggers>
</Configuration>